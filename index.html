<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Barber Motorsports Park — Density Altitude (History + Forecast)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --bg:#0f1115; --panel:#161a22; --text:#e9edf1; --muted:#9aa3ad; --accent:#5bc0de; --accent2:#71dd8a; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
  header { padding:22px 18px; text-align:center; background:linear-gradient(180deg,#141925, #0f1115); border-bottom:1px solid #222a36; }
  header h1 { margin:0 0 6px; font-size:20px; letter-spacing:.3px; }
  header p { margin:0; color:var(--muted); font-size:13px; }
  main { max-width:1100px; margin:18px auto 36px; padding:0 16px; }
  .card { background:var(--panel); border:1px solid #222a36; border-radius:12px; padding:14px; }
  #controls { display:grid; grid-template-columns:1fr; gap:12px; }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
  label { font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px; }
  input, select, button { background:#0f131b; color:var(--text); border:1px solid #273142; border-radius:8px; padding:9px 10px; font-size:14px; }
  button { background:#1c2533; cursor:pointer; transition:.15s border-color,.15s transform; }
  button:hover { border-color:#3a4a62; transform:translateY(-1px); }
  .mode { display:flex; gap:10px; align-items:center; }
  .mode label { flex-direction:row; align-items:center; gap:8px; color:var(--text); font-size:14px; }
  #summary { display:flex; gap:16px; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px; }
  #error { color:#ff6b6b; margin-top:10px; font-size:13px; }
  canvas { background:#0c1016; border:1px solid #222a36; border-radius:12px; padding:8px; }
  .hint { color:var(--muted); font-size:12px; margin-top:6px; }
  .footer { margin-top:10px; color:var(--muted); font-size:12px; text-align:center; }
</style>
</head>
<body>
<header>
  <h1>Barber Motorsports Park — Density Altitude</h1>
  <p>Historical review + 7–10 day DA forecast (computed from temperature, humidity, and pressure).</p>
</header>

<main>
  <div class="card" id="controls">
    <div class="row">
      <div class="mode" role="radiogroup" aria-label="Mode">
        <label><input type="radio" name="mode" value="history" checked> History</label>
        <label><input type="radio" name="mode" value="forecast"> Forecast</label>
      </div>

      <div id="historyControls" class="row">
        <label>Start date
          <input type="date" id="start">
        </label>
        <label>End date
          <input type="date" id="end">
        </label>
        <button id="loadHistory">Load history</button>
      </div>

      <div id="forecastControls" class="row" style="display:none">
        <label>Days ahead
          <select id="forecastDays">
            <option value="7">7 days</option>
            <option value="8">8 days</option>
            <option value="9">9 days</option>
            <option value="10" selected>10 days</option>
            <option value="14">14 days</option>
          </select>
        </label>
        <button id="loadForecast">Load forecast</button>
        <div class="hint">Tip: Forecast uses hourly model data; confidence tapers the farther out you go.</div>
      </div>
    </div>

    <!-- ZIP code input -->
    <label>ZIP Code
      <input type="text" id="zipCode" placeholder="Enter ZIP">
      <button id="setZip">Set Location</button>
    </label>

    <div id="summary"></div>
    <div id="error" role="alert"></div>
  </div>

  <div style="height:18px"></div>

  <div class="card">
    <canvas id="chart" height="360"></canvas>
    <div class="footer">Min/Max band shows daily range from hourly DA. Average line shows the daily mean.</div>
  </div>
</main>

<script>
/** =================== CONFIG =================== **/
const site = { // Barber Motorsports Park (near Leeds, AL)
  name: "Barber Motorsports Park",
  lat: 33.5315,
  lon: -86.6191,
  elevationFt: 620,
  tz: "America/Chicago"
};

// Chart state
let daChart;

// Wire up UI
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const startEl = $('#start');
const endEl = $('#end');
const forecastDaysEl = $('#forecastDays');
const errorEl = $('#error');
const summaryEl = $('#summary');
const zipEl = $('#zipCode');
const setZipBtn = $('#setZip');

// Initialize defaults (last full month as example)
(function initDates(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  startEl.value = new Date(year, month, 1).toISOString().slice(0,10);
  endEl.value   = new Date(year, month+1, 0).toISOString().slice(0,10);
})();

// Mode toggle
$$('input[name="mode"]').forEach(r => {
  r.addEventListener('change', () => {
    const mode = getMode();
    $('#historyControls').style.display = mode === 'history' ? '' : 'none';
    $('#forecastControls').style.display = mode === 'forecast' ? '' : 'none';
    clearOutputs();
  });
});

$('#loadHistory').addEventListener('click', handleHistory);
$('#loadForecast').addEventListener('click', handleForecast);

// ZIP code button
setZipBtn.addEventListener('click', async () => {
  const zip = zipEl.value.trim();
  if (!zip) { errorEl.textContent = 'Please enter a ZIP code.'; return; }
  clearOutputs();
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${zip}&country=US`);
    const data = await res.json();
    if (!data || data.length === 0) throw new Error('ZIP code not found.');
    const loc = data[0];
    site.lat = parseFloat(loc.lat);
    site.lon = parseFloat(loc.lon);
    summaryEl.textContent = `Location set to ZIP ${zip} (Lat: ${site.lat.toFixed(4)}, Lon: ${site.lon.toFixed(4)})`;
  } catch (e) {
    errorEl.textContent = `Error setting ZIP: ${e.message || e}`;
  }
});

// Helpers
function getMode(){ return $$('input[name="mode"]').find(r=>r.checked).value; }
function clearOutputs(){ errorEl.textContent=''; summaryEl.textContent=''; }

/** =============== DATA PIPELINE =============== **/
async function handleHistory(){
  clearOutputs();
  const start = startEl.value;
  const end   = endEl.value;
  if (!start || !end) { errorEl.textContent = 'Please select start and end dates.'; return; }
  try {
    const hourly = await fetchHourlyArchive(site.lat, site.lon, start, end, site.tz);
    if (!hourly || !hourly.time || hourly.time.length === 0) throw new Error('No hourly data returned.');
    const daily = reduceHourlyToDailyDA(hourly, site.elevationFt);
    render(daily, 'History');
  } catch (e) {
    errorEl.textContent = `Error: ${e.message || e}`;
  }
}

async function handleForecast(){
  clearOutputs();
  const days = parseInt(forecastDaysEl.value, 10);
  try {
    const hourly = await fetchHourlyForecast(site.lat, site.lon, days, site.tz);
    if (!hourly || !hourly.time || hourly.time.length === 0) throw new Error('No hourly forecast returned.');
    const daily = reduceHourlyToDailyDA(hourly, site.elevationFt);
    render(daily, `Forecast (${days}d)`, true);
  } catch (e) {
    errorEl.textContent = `Error: ${e.message || e}`;
  }
}

/** -------- Open-Meteo fetchers (keyless, CORS) -------- **/
async function fetchHourlyArchive(lat, lon, start, end, tz){
  const url = new URL('https://archive-api.open-meteo.com/v1/archive');
  url.search = new URLSearchParams({
    latitude: lat, longitude: lon,
    start_date: start, end_date: end,
    timezone: tz,
    hourly: ['temperature_2m','relative_humidity_2m','surface_pressure'].join(',')
  });
  const res = await fetch(url);
  const json = await res.json();
  if (!json?.hourly) throw new Error(json?.reason || 'Archive API error');
  return json.hourly;
}

async function fetchHourly
